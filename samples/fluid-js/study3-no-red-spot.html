<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fluid Art Study 3 - Piros folt megold√°s (Monkey Patch)</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            overflow: hidden;
            background: white;
        }

        canvas {
            display: block;
            width: 100vw;
            height: 100vh;
        }

        #debug {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: #0f0;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            z-index: 1000;
            max-width: 400px;
        }
    </style>
</head>
<body>
    <canvas id="renderSurface"></canvas>
    <div id="debug">
        <div>üîß Fluid Art Study 3 - Monkey Patch strat√©gia</div>
        <div id="status">‚è≥ Bet√∂lt√©s...</div>
    </div>

    <!-- Fluid-JS CDN -->
    <script src="https://cdn.jsdelivr.net/npm/fluid-canvas@latest"></script>

    <script>
        // ============================================
        // PARAM√âTEREK
        // ============================================

        const PHYSICS_CONFIG = {
            sim_resolution: 128,
            dye_resolution: 512,
            dissipation: 0.998,      // Lassabb halv√°nyod√°s
            velocity: 0.999,         // Lassabb lassul√°s
            pressure: 0.8,
            pressure_iteration: 20,
            curl: 10,                // Alacsonyabb √∂rv√©nyl√©s
            emitter_size: 2.5,       // Nagyobb foltok
            render_shaders: true,
            multi_color: false,
            render_bloom: false,
            background_color: { r: 255, g: 255, b: 255 },
            transparent: false
        };

        const FLUID_COLORS_RGB = [
            { r: 0, g: 255, b: 255 },    // T√ºrkiz
            { r: 204, g: 51, b: 255 },   // Lila
            { r: 0, g: 128, b: 255 }     // Kir√°lyk√©k
        ];

        const MOUSE_CONFIG = {
            speed_threshold: 300,    // Magas k√ºsz√∂b (ritk√°bb interakci√≥)
            throttle_rate: 3
        };

        const INITIAL_SPLATS = {
            count: 5,
            delay_between: 250,
            move_distance: 50,
            move_steps: 1
        };

        // ============================================
        // DEBUG LOG
        // ============================================

        function log(msg, color = '#0f0') {
            const status = document.getElementById('status');
            const timestamp = new Date().toLocaleTimeString();
            status.innerHTML += `<div style="color:${color}">[${timestamp}] ${msg}</div>`;
            console.log(msg);
        }

        // ============================================
        // MONKEY PATCH STRAT√âGIA
        // ============================================

        const canvas = document.getElementById('renderSurface');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        log('üé® Canvas l√©trehozva');

        // STRAT√âGIA 1: Megpr√≥b√°ljuk elfogni a Fluid konstruktor h√≠v√°st
        // √©s AZONNAL fel√ºl√≠rni a multipleSplats met√≥dust
        const OriginalFluid = window.Fluid;

        if (!OriginalFluid) {
            log('‚ùå Fluid library nem tal√°lhat√≥!', '#f00');
        } else {
            log('‚úÖ Fluid library bet√∂ltve');

            // Wrapper a Fluid konstruktor k√∂r√ºl
            window.Fluid = function(canvasElement) {
                log('üîß Fluid konstruktor h√≠vva - monkey patch alkalmaz√°sa...');

                // Eredeti konstruktor h√≠v√°sa
                const instance = new OriginalFluid(canvasElement);

                log('‚úÖ Fluid instance l√©trehozva');

                // MONKEY PATCH: Fel√ºl√≠rjuk a multipleSplats met√≥dust
                // (ha el√©rhet≈ë a prototype-on vagy az instance-on)

                // 1. Pr√≥b√°lkoz√°s: Instance szinten
                if (typeof instance.multipleSplats === 'function') {
                    log('üîß multipleSplats() met√≥dus tal√°lva (instance szint)');
                    const originalMultipleSplats = instance.multipleSplats;

                    instance.multipleSplats = function(amount) {
                        log(`üö´ multipleSplats(${amount}) BLOKKOLVA - feh√©r folt helyett NOP`, '#ff0');
                        // Nem csin√°lunk semmit - √≠gy nem jelenik meg a piros/feh√©r folt
                        return;
                    };

                    log('‚úÖ multipleSplats() monkey patch SIKERES (instance)', '#0ff');
                }

                // 2. Pr√≥b√°lkoz√°s: Prototype szinten
                if (OriginalFluid.prototype && typeof OriginalFluid.prototype.multipleSplats === 'function') {
                    log('üîß multipleSplats() met√≥dus tal√°lva (prototype szint)');
                    const originalProtoMultipleSplats = OriginalFluid.prototype.multipleSplats;

                    OriginalFluid.prototype.multipleSplats = function(amount) {
                        log(`üö´ multipleSplats(${amount}) BLOKKOLVA - feh√©r folt helyett NOP (proto)`, '#ff0');
                        return;
                    };

                    log('‚úÖ multipleSplats() monkey patch SIKERES (prototype)', '#0ff');
                }

                return instance;
            };

            // M√°soljuk √°t az eredeti konstruktor tulajdons√°gait
            Object.setPrototypeOf(window.Fluid, OriginalFluid);
            Object.setPrototypeOf(window.Fluid.prototype, OriginalFluid.prototype);
        }

        // ============================================
        // FLUID INICIALIZ√ÅL√ÅS
        // ============================================

        let myFluid;
        let lastX = -1;
        let lastY = -1;
        let isSimulating = false;
        let moveCounter = 0;

        setTimeout(() => {
            log('üé® Fluid objektum l√©trehoz√°sa...');

            try {
                myFluid = new Fluid(canvas);
                log('‚úÖ Fluid objektum l√©trehozva');

                // Konfigur√°ci√≥
                myFluid.mapBehaviors(PHYSICS_CONFIG);
                log('‚úÖ Fizikai param√©terek be√°ll√≠tva');

                // STRAT√âGIA 2: Ha a monkey patch nem m≈±k√∂d√∂tt,
                // pr√≥b√°ljuk meg k√∂zvetlen√ºl is fel√ºl√≠rni
                if (myFluid.multipleSplats && typeof myFluid.multipleSplats === 'function') {
                    log('üîß M√°sodlagos monkey patch - direkt override');
                    myFluid.multipleSplats = function(amount) {
                        log(`üö´ multipleSplats(${amount}) BLOKKOLVA (direkt)`, '#ff0');
                        return;
                    };
                }

                // Aktiv√°l√°s EL≈êTT pr√≥b√°ljuk blokkolni a multipleSplats-et
                setTimeout(() => {
                    log('üöÄ Fluid aktiv√°l√°sa...');
                    myFluid.activate();
                    log('‚úÖ Fluid aktiv√°lva');

                    // Kezdeti splat-ok l√©trehoz√°sa 300ms ut√°n
                    setTimeout(() => {
                        createInitialSplats();
                    }, 300);
                }, 100);

            } catch (error) {
                log(`‚ùå Hiba: ${error.message}`, '#f00');
                console.error(error);
            }
        }, 500);

        // ============================================
        // SPLAT L√âTREHOZ√ÅS
        // ============================================

        function createInitialSplats() {
            log(`üé® ${INITIAL_SPLATS.count} kezdeti splat l√©trehoz√°sa...`, '#ff0');

            for (let i = 0; i < INITIAL_SPLATS.count; i++) {
                setTimeout(() => {
                    isSimulating = true;
                    const x = (0.2 + Math.random() * 0.6) * canvas.width;
                    const y = (0.2 + Math.random() * 0.6) * canvas.height;

                    // Sz√≠nbe√°ll√≠t√°s
                    const colorIndex = i % FLUID_COLORS_RGB.length;
                    myFluid.color = FLUID_COLORS_RGB[colorIndex];

                    // Kattint√°s szimul√°ci√≥
                    canvas.dispatchEvent(new MouseEvent('mousedown', {
                        clientX: x,
                        clientY: y,
                        bubbles: true,
                        cancelable: true
                    }));

                    // Mozg√°s
                    for (let step = 1; step <= INITIAL_SPLATS.move_steps; step++) {
                        setTimeout(() => {
                            const angle = Math.random() * Math.PI * 2;
                            const dist = (INITIAL_SPLATS.move_distance * step) / INITIAL_SPLATS.move_steps;
                            canvas.dispatchEvent(new MouseEvent('mousemove', {
                                clientX: x + Math.cos(angle) * dist,
                                clientY: y + Math.sin(angle) * dist,
                                bubbles: true,
                                cancelable: true
                            }));
                        }, step * 20);
                    }

                    // Mouse up
                    setTimeout(() => {
                        const angle = Math.random() * Math.PI * 2;
                        canvas.dispatchEvent(new MouseEvent('mouseup', {
                            clientX: x + Math.cos(angle) * INITIAL_SPLATS.move_distance,
                            clientY: y + Math.sin(angle) * INITIAL_SPLATS.move_distance,
                            bubbles: true,
                            cancelable: true
                        }));
                        isSimulating = false;

                        const colorName = ['t√ºrkiz', 'lila', 'k√©k'][colorIndex];
                        log(`‚úÖ Splat ${i+1}/${INITIAL_SPLATS.count}: ${colorName}`, '#0ff');
                    }, INITIAL_SPLATS.move_steps * 20 + 50);
                }, i * INITIAL_SPLATS.delay_between);
            }
        }

        // ============================================
        // EG√âR INTERAKCI√ì
        // ============================================

        canvas.addEventListener('mousemove', (e) => {
            if (isSimulating || !e.isTrusted || !myFluid) return;

            const x = e.clientX;
            const y = e.clientY;

            if (lastX !== -1 && lastY !== -1) {
                const dx = x - lastX;
                const dy = y - lastY;
                const speed = Math.sqrt(dx * dx + dy * dy);

                moveCounter++;
                if (speed > MOUSE_CONFIG.speed_threshold &&
                    moveCounter % MOUSE_CONFIG.throttle_rate === 0) {
                    isSimulating = true;

                    const colorIndex = Math.floor(Math.random() * FLUID_COLORS_RGB.length);
                    myFluid.color = FLUID_COLORS_RGB[colorIndex];

                    canvas.dispatchEvent(new MouseEvent('mousedown', {
                        clientX: x,
                        clientY: y,
                        bubbles: true
                    }));

                    setTimeout(() => {
                        canvas.dispatchEvent(new MouseEvent('mouseup', {
                            clientX: x + dx,
                            clientY: y + dy,
                            bubbles: true
                        }));
                        isSimulating = false;
                    }, 20);
                }
            }

            lastX = x;
            lastY = y;
        }, { passive: true });

        // ============================================
        // RESIZE
        // ============================================

        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        });

        log('‚úÖ Study 3 bet√∂ltve - monkey patch akt√≠v!', '#0ff');
    </script>
</body>
</html>
